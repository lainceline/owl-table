var OwlCell = React.createClass({
	displayName: 'OwlCell',
	propTypes: {

	},
	render: function () {

	}
});

var OwlRow = React.createClass({
	displayName: 'OwlRow',
	propTypes: {
		data: React.PropTypes.object.isRequired,
		columns: React.PropTypes.array.isRequired,
		key: React.PropTypes.number.isRequired
	},
	render: function () {
		var props = this.props;

		var cells = props.columns.map(function (column, index) {
			return (
				React.createElement("td", {key: index, 'data-field': column.field}, 
					props.data[column.field] || '---'
				)
			);
		});

		return(
			React.createElement("tr", {className: "owl-row", key: props.key}, 
				cells
			)
		);
	}
});

var OwlTableReact = React.createClass({
	displayName: 'OwlTable',
	propTypes: {
		data: React.PropTypes.array.isRequired,
		columns: React.PropTypes.array.isRequired
	},
	render: function () {

		var props = this.props;
		var count = 0;

		var headers = props.columns.map(function (column, index) {
			return (
				React.createElement("th", {key: index, 'data-field': column.field}, 
					column.title || 'None'
				)
			);
		});

		var rows = props.data.map(function (datum, index) {
			return (
				React.createElement(OwlRow, {data: datum, columns: props.columns, key: index})
			);
		});

		return (
			React.createElement("table", {className: "owl-table"}, 
				React.createElement("thead", null, 
					headers
				), 
				React.createElement("tbody", null, 
					rows
				)
			)
		);
	}
});

(function(module) {
try {
  module = angular.module('owlTablePartials');
} catch (e) {
  module = angular.module('owlTablePartials', []);
}
module.run(['$templateCache', function($templateCache) {
  $templateCache.put('partials/export.html',
    '<div class="owl-export-controls"><span class="owl-control-label">Export:</span><span class="owl-export-buttons"><span class="owl-export-button-csv"></span><span class="owl-export-button-print"></span></span></div>');
}]);
})();

(function(module) {
try {
  module = angular.module('owlTablePartials');
} catch (e) {
  module = angular.module('owlTablePartials', []);
}
module.run(['$templateCache', function($templateCache) {
  $templateCache.put('partials/filter.html',
    '<div class="owl-filter-controls"><span class="owl-control-label">Filters:</span><span class="owl-filter-buttons">OFF</span></div>');
}]);
})();

(function(module) {
try {
  module = angular.module('owlTablePartials');
} catch (e) {
  module = angular.module('owlTablePartials', []);
}
module.run(['$templateCache', function($templateCache) {
  $templateCache.put('partials/pagination.html',
    '<div class="owl-pagination-buttons active"><button ng-click="owlCtrl.prevPage()" class="owl-pagination-button owl-previous-page">&lt; Prev</button><div class="owl-page-count">Page <input type="text" size="3" ng-model="owlCtrl.owlTable.page">&nbsp;&nbsp;of {{owlCtrl.owlTable.pages}}</div><button ng-click="owlCtrl.nextPage()" class="owl-pagination-button owl-next-page">Next &gt;</button></div>');
}]);
})();

(function(module) {
try {
  module = angular.module('owlTablePartials');
} catch (e) {
  module = angular.module('owlTablePartials', []);
}
module.run(['$templateCache', function($templateCache) {
  $templateCache.put('partials/table.html',
    '<div class="container-fluid owl-wrapper"><div class="owl-top-controls"><owl-pagination></owl-pagination><owl-export-controls></owl-export-controls><owl-filter-controls></owl-filter-controls><button id="saveButton" class="btn btn-sm btn-default">Save</button></div><div class="owl-table-wrapper table-responsive"><div class="owl-table-inner-wrapper"><div class="owl-react-container"></div></div></div><owl-pagination></owl-pagination></div>');
}]);
})();

angular.module(
	'owlTable',
	[
		'owlTablePartials'
	]
);

(function () {
	angular.module('owlTable').constant('owlConstants', {
		defaults: {
			PER_PAGE: 25
		}
	});
})();

function owlTableService ($rootScope, owlConstants) {
	var service = {};

	service.tables = [];

	service.page = 1;
	service.pages = 20;
	service.total = 0;
	service.count = owlConstants.defaults.PER_PAGE;

	service.registerTable = function (id) {
		this.tables.push({ id: id });
	};

	service.tableWithId = function (id) {
		return this.tables.map(function (table) {
			if (table.id === id) {
				return table;
			}
		});
	};

	service.setCount = function (count) {
		this.count = count;
		$rootScope.$broadcast('owlCountChanged');
	};

	service.nextPage = function () {
		if (this.page < this.pages) {
			this.page += 1;
		}
	};

	service.prevPage = function () {
		if (this.page > 1) {
			this.page -= 1;
		}
	};

	return service;
}

angular.module('owlTable').service('owlTableService', ['$rootScope', 'owlConstants', owlTableService]);

function owlTableDirective (owlTableService) {
	return {
		restrict: 'EA',
		scope: {
			data: '=',
			columns: '='
		},
		templateUrl: 'partials/table.html',
		controllerAs: 'owlCtrl',
		compile: function (tElem, tAttrs) {
			owlTableService.registerTable(tElem[0].id);

			return function link (scope, elem, attrs) {
				var table;
				var rendered;
				var container = elem.find('.owl-react-container')[0];

				table = React.createElement(OwlTableReact, {
					data: scope.data,
					columns: scope.columns
				});

				rendered = React.render(table, container);

				scope.$watchCollection('data', function (newValue, oldValue) {
					console.log('owl table watch on data was called');
					if (newValue !== oldValue) {
						console.log('and a change was detected');
						rendered.setProps({
							data: newValue
						});
					}
				});
			};
		},
		controller: function ($scope) {
			this.owlTable = owlTableService;

			this.nextPage = function () {
				owlTableService.nextPage();
				$scope.$emit('owlNextPage');
			};

			this.prevPage = function () {
				owlTableService.prevPage();
				$scope.$emit('owlPrevPage');
			};
		}
	};
}

function owlPagination (owlTableService) {
	return {
		restrict: 'EA',
		require: '^owlTable',
		templateUrl: 'partials/pagination.html',
		compile: function (tElem, tAttrs) {
			return function link (scope, elem, attrs) {

			};
		}
	};
}

function owlFilterControls (owlTableService) {
	return {
		restrict: 'EA',
		require: '^owlTable',
		templateUrl: 'partials/filter.html',
		compile: function (tElem, tAttrs) {
			return function link (scope, elem, attrs) {};
		}
	};
}

function owlExportControls (owlTableService) {
	return {
		restrict: 'EA',
		require: '^owlTable',
		templateUrl: 'partials/export.html',
		compile: function (tElem, tAttrs) {
			return function link (scope, elem, attrs) {};
		}
	};
}

angular.module('owlTable')
	.directive('owlTable', ['owlTableService', owlTableDirective])
	.directive('owlPagination', ['owlTableService', owlPagination])
	.directive('owlFilterControls', ['owlTableService', owlFilterControls])
	.directive('owlExportControls', ['owlTableService', owlExportControls]);
